<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zurich Airport Restaurants</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">

<!-- HEADER -->
<header class="bg-gray-900 text-white p-6 text-center shadow-lg flex flex-col items-center justify-center space-y-3">
  <img src="https://logoref.wordpress.com/wp-content/uploads/2014/06/zurichairport.jpg?w=1272" 
       alt="Airplane" class="w-40 h-20 opacity-90">
  <h1 class="text-3xl font-bold tracking-wide">Zurich Airport Restaurants</h1>
</header>

<!-- FILTERS -->
<div class="p-4 space-y-4">
  <input 
    type="text" 
    id="search"
    placeholder="Search by name, cuisine, or info…" 
    class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
  
  <select 
    id="areaFilter"
    class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
    <option value="all">All areas</option>
    <option value="Public">Public Area</option>
    <option value="Passenger">Passenger Area</option>
  </select>

  <button id="resetFilters"
          class="w-full p-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
    Reset Filters
  </button>
</div>

<!-- ACTIVE GLOBAL VARIABLES DISPLAY -->
<div id="activeGlobals" class="p-4 space-y-2 text-gray-700"></div>

<!-- LIST -->
<div id="restaurantList" class="p-4 space-y-6"></div>

<script>
let globalVariables = { restaurantType: "", searchValue: "" };
let restaurantsData = [];
let itemId = null; // store MockAPI item ID
const apiURL = "https://6797e9d9c2c861de0c6e6bdf.mockapi.io/search";

// FETCH DATA
async function fetchRestaurants() {
  try {
    const response = await fetch(apiURL);
    const data = await response.json();

    const mainData = data[0]; // first item
    itemId = mainData.id;

    globalVariables = mainData.global;
    restaurantsData = mainData.restaurants;

    // Apply global variables as defaults
    document.getElementById("search").value = globalVariables.searchValue || "";
    updateActiveGlobalsDisplay();
    filterList();
  } catch (error) {
    console.error("Error fetching restaurants:", error);
    document.getElementById("restaurantList").innerHTML =
      "<p class='text-center text-red-500'>Failed to load restaurants.</p>";
  }
}

// UPDATE ACTIVE GLOBALS DISPLAY
function updateActiveGlobalsDisplay() {
  const container = document.getElementById("activeGlobals");
  const activeText = [];

  if (globalVariables.restaurantType) activeText.push(`Type: ${globalVariables.restaurantType}`);
  if (globalVariables.searchValue) activeText.push(`Search: ${globalVariables.searchValue}`);

  container.innerHTML = activeText.length
    ? `<p>Active global filters: ${activeText.join(", ")}</p>`
    : "";
}

// RENDER CARDS
function renderList(items) {
  const listEl = document.getElementById("restaurantList");
  listEl.innerHTML = "";

  if (items.length === 0) {
    listEl.innerHTML = '<p class="text-center text-gray-500">No restaurants found.</p>';
    return;
  }

  items.forEach(r => {
    const mapURL = r.mapLink || `https://www.google.com/maps?q=${r.lat},${r.lng}`;

    const card = document.createElement("div");
    card.className =
      "bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition shadow-md flex flex-col sm:flex-row";

    card.innerHTML = `
      <div class="w-full sm:w-36 h-40 sm:h-32 overflow-hidden flex-shrink-0">
        <img src="${r.photoURL}" alt="Photo of ${r.name}" class="w-full h-full object-cover sm:rounded-l-xl rounded-t-xl">
      </div>

      <div class="p-5 flex-1 flex flex-col justify-between space-y-2">
        <div>
          <h2 class="text-xl font-semibold">${r.name}</h2>
          <p class="text-gray-700"><strong>Area:</strong> ${r.area}</p>
          <p class="text-gray-700"><strong>Type:</strong> ${r.cuisine || "—"}</p>
          <p class="text-gray-600">${r.locationInfo}</p>
        </div>

        <div class="flex space-x-3 mt-3">
          ${r.website ? `<a href="${r.website}" target="_blank" rel="noopener noreferrer"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Website</a>` : ""}
          <a href="${mapURL}" target="_blank" rel="noopener noreferrer"
             class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Map</a>
        </div>
      </div>
    `;
    listEl.appendChild(card);
  });
}

// FILTER LOGIC
function filterList() {
  const searchText = document.getElementById("search").value.toLowerCase();
  const area = document.getElementById("areaFilter").value;

  let filtered = restaurantsData.filter(r => {
    const matchSearch = !searchText ||
      r.name.toLowerCase().includes(searchText) ||
      r.cuisine.toLowerCase().includes(searchText) ||
      r.locationInfo.toLowerCase().includes(searchText);

    const matchArea = area === "all" || r.area === area;

    const matchType = globalVariables.restaurantType
      ? r.cuisine.toLowerCase().includes(globalVariables.restaurantType.toLowerCase())
      : true;

    return matchSearch && matchArea && matchType;
  });

  // Prioritize exact match if global.searchValue exists
  if (globalVariables.searchValue) {
    const exact = filtered.filter(r =>
      r.name.toLowerCase().includes(globalVariables.searchValue.toLowerCase())
    );
    const rest = filtered.filter(
      r => !r.name.toLowerCase().includes(globalVariables.searchValue.toLowerCase())
    );
    filtered = [...exact, ...rest];
  }

  renderList(filtered);
}

// RESET FILTERS
async function resetFilters() {
  document.getElementById("search").value = "";
  document.getElementById("areaFilter").value = "all";

  globalVariables.restaurantType = "";
  globalVariables.searchValue = "";

  updateActiveGlobalsDisplay();
  filterList();

  try {
    if (itemId) {
      await fetch(`${apiURL}/${itemId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ global: globalVariables })
      });
    }
  } catch (error) {
    console.error("Error resetting global variables in API:", error);
  }
}

// EVENT LISTENERS
document.getElementById("search").addEventListener("input", filterList);
document.getElementById("areaFilter").addEventListener("change", filterList);
document.getElementById("resetFilters").addEventListener("click", resetFilters);

// INITIAL LOAD + AUTO-POLL
fetchRestaurants();
setInterval(fetchRestaurants, 5000);
</script>

</body>
</html>
